name: Deploy Windows Application

on:
  push:
    branches:
      - ci/cd
  pull_request:
    branches:
      - ci/cd

jobs:
  deploy:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      
      - name: Set up MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          spectre: true
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw81'
          dir: '${{ github.workspace }}/qt'
          install-deps: 'true'
          set-env: 'true'
          cache: 'true'
      
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -G "MinGW Makefiles" ..
      
      - name: Build project
        run: |
          cmake --build build --config Release
      
      - name: Deploy with windeployqt
        run: |
          mkdir deploy
          cd deploy
          ${{ github.workspace }}/qt/6.7.0/mingw_64/bin/windeployqt.exe ../build/Release/Advanced-Tic-Tac-Toe.exe --no-compiler-runtime --no-translations --no-opengl-sw
      
      - name: Create ZIP archive
        run: |
          Compress-Archive -Path deploy/* -DestinationPath Advanced-Tic-Tac-Toe-Windows.zip
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: Advanced-Tic-Tac-Toe-Windows
          path: Advanced-Tic-Tac-Toe-Windows.zip
